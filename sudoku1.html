<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Sudoku Solver</title>
<style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; text-align: center; }
    table { border-collapse: collapse; margin: 20px auto; }
    td { width: 50px; height: 50px; border: 1px solid #555; text-align: center; font-size: 24px; position: relative; vertical-align: middle; background: white; }
    td.selected { background: #d0e6ff !important; }
    td.logic { background: #b6f7b0 !important; }
    td.guess { background: #ffd27f !important; }
    td.backtrack { background: #ff9c9c !important; }
    td:nth-child(3n) { border-right: 3px solid black; }
    tr:nth-child(3n) td { border-bottom: 3px solid black; }
    td:first-child { border-left: 3px solid black; }
    tr:first-child td { border-top: 3px solid black; }
    .candidates {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        font-size: 10px;
        color: #666;
    }
    .controls { margin-top: 20px; }
    button { padding: 8px 16px; font-size: 16px; margin: 5px; cursor: pointer; }
</style>
</head>
<body>

<h1>Sudoku Solver</h1>
<table id="sudoku"><tbody></tbody></table>

<div class="controls">
    <button onclick="clearBoard()">Очистить</button>
    <button onclick="solveBoard()">Решить</button>
    <button onclick="prevStep()">←</button>
    <button onclick="nextStep()">→</button>
    <button onclick="startAuto()">▶</button>
    <button onclick="stopAuto()">⏸</button>
</div>

<script>
let board = Array.from({length: 9}, () => Array(9).fill(""));
let userBoard = Array.from({length: 9}, () => Array(9).fill(false));
let finalBoard = Array.from({length: 9}, () => Array(9).fill(null));
let steps = [];
let stepIndex = 0;
let selected = null;
let autoPlayTimer = null;

function createBoard() {
    let tbody = document.querySelector("#sudoku tbody");
    tbody.innerHTML = "";
    for (let r = 0; r < 9; r++) {
        let tr = document.createElement("tr");
        for (let c = 0; c < 9; c++) {
            let td = document.createElement("td");
            td.dataset.row = r;
            td.dataset.col = c;
            td.addEventListener("click", () => selectCell(td));
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
    }
}
createBoard();

function selectCell(cell) {
    document.querySelectorAll("td").forEach(td => td.classList.remove("selected"));
    cell.classList.add("selected");
    selected = cell;
}

document.addEventListener("keydown", (e) => {
    if (!selected) return;
    let r = parseInt(selected.dataset.row);
    let c = parseInt(selected.dataset.col);

    if (e.key >= "1" && e.key <= "9") {
        board[r][c] = e.key;
        userBoard[r][c] = true;
        selected.textContent = e.key;
        selected.style.background = "white";
        moveNext();
    } else if (e.key === " " || e.key === "Backspace" || e.key === "Delete") {
        board[r][c] = "";
        userBoard[r][c] = false;
        selected.textContent = "";
        moveNext();
    } else if (e.key === "ArrowUp") moveSelect(r-1, c);
    else if (e.key === "ArrowDown") moveSelect(r+1, c);
    else if (e.key === "ArrowLeft") moveSelect(r, c-1);
    else if (e.key === "ArrowRight") moveSelect(r, c+1);
});

function moveNext() {
    let r = parseInt(selected.dataset.row);
    let c = parseInt(selected.dataset.col);
    if (c < 8) moveSelect(r, c+1);
    else if (r < 8) moveSelect(r+1, 0);
}

function moveSelect(r, c) {
    if (r < 0 || r > 8 || c < 0 || c > 8) return;
    let cell = document.querySelector(`td[data-row='${r}'][data-col='${c}']`);
    selectCell(cell);
}

function clearBoard() {
    board = Array.from({length: 9}, () => Array(9).fill(""));
    userBoard = Array.from({length: 9}, () => Array(9).fill(false));
    finalBoard = Array.from({length: 9}, () => Array(9).fill(null));
    steps = [];
    stepIndex = 0;
    document.querySelectorAll("td").forEach(td => {
        td.innerHTML = "";
        td.className = "";
        td.style.background = "white";
    });
    stopAuto();
}

async function solveBoard() {
    stopAuto();
    userBoard = board.map(row => row.map(v => v !== ""));
    finalBoard = board.map(row => row.map(v => v || null));

    let response = await fetch("/solve", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({board})
    });
    let data = await response.json();
    if (data.error) {
        alert(data.error);
        return;
    }
    steps = data.steps;
    stepIndex = 0;
    renderStep();
}

function renderStep() {
    // Пересчитываем finalBoard до текущего шага
    finalBoard = board.map(row => row.map(v => v || null));
    for (let i = 0; i <= stepIndex; i++) {
        let s = steps[i];
        if (s.type === "logic" || s.type === "guess") {
            finalBoard[s.row][s.col] = s.num;
        }
        if (s.type === "backtrack") {
            finalBoard[s.row][s.col] = null;
        }
    }

    document.querySelectorAll("td").forEach(td => {
        td.innerHTML = "";
        td.className = "";
        td.style.background = "white";
    });

    let state = steps[stepIndex];
    for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
            let cell = document.querySelector(`td[data-row='${r}'][data-col='${c}']`);
            let val = finalBoard[r][c];
            if (val) {
                cell.textContent = val;
                if (!userBoard[r][c]) {
                    cell.classList.add("logic");
                }
            } else {
                let candidates = state.candidates[r][c];
                if (candidates.length > 0) {
                    let div = document.createElement("div");
                    div.className = "candidates";
                    candidates.forEach(num => {
                        let span = document.createElement("div");
                        span.textContent = num;
                        div.appendChild(span);
                    });
                    cell.appendChild(div);
                }
            }
        }
    }
    if (state.type && state.type !== "start") {
        let cell = document.querySelector(`td[data-row='${state.row}'][data-col='${state.col}']`);
        if (!userBoard[state.row][state.col]) {
            if (state.type === "guess") cell.classList.add("guess");
            if (state.type === "backtrack") cell.classList.add("backtrack");
        }
    }
}

function prevStep() {
    if (stepIndex > 0) {
        stepIndex--;
        renderStep();
    }
}

function nextStep() {
    if (stepIndex < steps.length - 1) {
        stepIndex++;
        renderStep();
    }
}

function startAuto() {
    stopAuto();
    autoPlayTimer = setInterval(() => {
        if (stepIndex < steps.length - 1) {
            stepIndex++;
            renderStep();
        } else {
            stopAuto();
        }
    }, 500);
}

function stopAuto() {
    if (autoPlayTimer) {
        clearInterval(autoPlayTimer);
        autoPlayTimer = null;
    }
}
</script>

</body>
</html>
